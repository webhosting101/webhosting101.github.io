<html>
<body>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/1.10.100/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.worker.entry.min.js" ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/1.10.100/pdf.worker.min.js"></script>
    <input type="file" id="file-id" name="file_name" onchange="validateFile()">
    <br/>
    <br/>
    <div id="passDiv" style="display: none;">
        <label for="password">password:</label>
        <input type="text" id="password" name="password"><br/>
    </div>
    <button type="button" onclick="extractText();">Generate</button><br/><br/>
    <!-- a container for the output -->
    <!-- <div id="output"></div> -->

    <script>
        var datass = '';
        var DataArr = [];
        PDFJS.workerSrc = '';
        function validateFile(){
            var input = document.getElementById("file-id");
            var fReader = new FileReader();
            fReader.readAsBinaryString(input.files[0]);
            fReader.onloadend = function (event) {
                PDFJS.getDocument({ data: event.target.result, password: password.value }).then(function (pdf) {
                    // PDF loading Success
                }, function (reason) {
                    // PDF loading error
                    console.log(reason);
                    if(reason.name === 'PasswordException'){
                        document.getElementById("passDiv").style = '';
                    }
                });
            }
        }
        function extractText() {
            var input = document.getElementById("file-id");
            var password = document.getElementById("password");
            var fReader = new FileReader();
            fReader.readAsBinaryString(input.files[0]);
            // console.log(password.value);
            fReader.onloadend = function (event) {
                // convertDataURIToBinary(event.target.result);
                pdfAsArray({ data: event.target.result, password: password.value },input.files[0].name);
            }

        }

        var BASE64_MARKER = ';base64,';

        function convertDataURIToBinary(dataURI) {

            var base64Index = dataURI.indexOf(BASE64_MARKER) + BASE64_MARKER.length;
            var base64 = dataURI.substring(base64Index);
            var raw = window.atob(base64);
            var rawLength = raw.length;
            var array = new Uint8Array(new ArrayBuffer(rawLength));

            for (var i = 0; i < rawLength; i++) {
                array[i] = raw.charCodeAt(i);
            }
            pdfAsArray(array)

        }

        function getPageText(pageNum, PDFDocumentInstance) {
            // Return a Promise that is solved once the text of the page is retrieven
            return new Promise(function (resolve, reject) {
                PDFDocumentInstance.getPage(pageNum).then(function (pdfPage) {
                    // The main trick to obtain the text of the PDF page, use the getTextContent method
                    pdfPage.getTextContent().then(function (textContent) {
                        var textItems = textContent.items;
                        var finalString = "";

                        // Concatenate the string of the item to the final string
                        for (var i = 0; i < textItems.length; i++) {
                            var item = textItems[i];

                            finalString += item.str + " ";
                        }

                        // Solve promise with the text retrieven from the page
                        resolve(finalString);
                    });
                });
            });
        }
        function downloadCSV(csvStr) {
            var hiddenElement = document.createElement('a');
            hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csvStr);
            hiddenElement.target = '_blank';
            hiddenElement.download = 'Import to Bluecoins.csv';
            hiddenElement.click();
        }
        function gcashParser(pagesText) {
            // Display text of all the pages in the console
            // e.g ["Text content page 1", "Text content page 2", "Text content page 3" ... ]
            // console.log(pagesText); // representing every single page of PDF Document by array indexing
            var outputStr = "";
            let startingIndicator = ' STARTING BALANCE ';
            let endingIndicator = ' ENDING BALANCE ';
            let startingBalance = 0;
            for (var pageNum = 0; pageNum < pagesText.length; pageNum++) {
                //get the year on the PDF File
                let pdfYear = pagesText[pageNum].split('History ')[1].substring(0, 4);
                let perRow = pagesText[pageNum].split(' '+pdfYear+'-');//year today
                //outputStr += "<br/><br/>Page " + (pageNum + 1) + " contents <br/> <br/>";
                outputStr +="(1)Type,(2)Date,(3)Item or Payee,(4)Amount,(5)Parent Category,(6)Catergory,(7)Account Type,(8)Account,(9)Notes,(10)Label,(11)Status,(12)Split";
                for (var rowNum = 0; rowNum < perRow.length; rowNum++) {
                    let row = perRow[rowNum];
                    if(row.indexOf(startingIndicator) > -1){
                        startingBalance = parseFloat(row.split(startingIndicator)[1]);
                    }
                    console.log(row,startingBalance);
                    if (row.indexOf(' AM ') > -1 || row.indexOf(' PM ') > -1) {// transactions only
                        //this will split the last row to just get the transaction
                        if(rowNum == perRow.length-1){
                            row = row.split(endingIndicator)[0];
                        }
                        let stringRow = '\n';
                        let splitRow = row.split(' ');
                        console.log(splitRow);
                        //(1)Type will always be expense for now
                        let debit = parseFloat(startingBalance-parseFloat(splitRow[splitRow.length-2])).toFixed(2)==parseFloat(splitRow[splitRow.length-1]).toFixed(2);
                        console.log(debit,parseFloat(startingBalance-parseFloat(splitRow[splitRow.length-2])).toFixed(2),parseFloat(splitRow[splitRow.length-1]).toFixed(2));
                        if(debit){
                            stringRow += 'e';
                            startingBalance = startingBalance-parseFloat(splitRow[splitRow.length-2]);
                        }else{
                            stringRow += 'i';
                            startingBalance = startingBalance+parseFloat(splitRow[splitRow.length-2]);
                        }
                        //(2)Date logic
                        let dateSplit = splitRow[0].split('-');//MM-DD
                        let timeSplit = splitRow[1].split(':');//HH:MM
                        let timeIn24h = (splitRow[2] === 'AM')?splitRow[1]:(parseInt(timeSplit[0])+12)+':'+timeSplit[1];
                        stringRow += ','+dateSplit[0]+'/'+dateSplit[1]+'/'+pdfYear+' '+timeIn24h; //Date MM/DD/YYYY
                        //(3)Item or Payee logic
                        stringRow += ','
                        for(let wordLoc = 3; wordLoc < splitRow.length - 3; wordLoc++){
                            stringRow += splitRow[wordLoc]+' ';
                        }
                        stringRow = stringRow.substring(0, stringRow.length - 1);
                        //(4)Amount logic
                        stringRow += ','+splitRow[splitRow.length-2];
                        //(5)Parent Category logic
                        stringRow += ',OTHERS';
                        //(6)Category logic
                        stringRow += ',Others';
                        //(7)Account Type logic
                        stringRow += ',VIRTUAL ACCOUNTS';
                        //(8)Account logic
                        stringRow += ',Gcash';
                        //(9)Notes logic
                        stringRow += ',';
                        //(10)Label logic
                        stringRow += ',Gcash';
                        //(11)Status logic
                        stringRow += ',';
                        //(12)Split logic
                        stringRow += ',';
                        console.log(stringRow);
                        outputStr += stringRow;
                    }
                }
                //outputStr += "\n<br/><br/>Page " + (pageNum + 1) + " contents <br/> <br/>";
                //document.getElementById('output').innerHTML = outputStr;
            }
            downloadCSV(outputStr);
        }
        function pdfAsArray(pdfAsArray,documentName) {

            PDFJS.getDocument(pdfAsArray).then(function (pdf) {

                var pdfDocument = pdf;
                // Create an array that will contain our promises
                var pagesPromises = [];

                for (var i = 0; i < pdf.pdfInfo.numPages; i++) {
                    // Required to prevent that i is always the total of pages
                    (function (pageNumber) {
                        // Store the promise of getPageText that returns the text of a page
                        pagesPromises.push(getPageText(pageNumber, pdfDocument));
                    })(i + 1);
                }

                // Execute all the promises
                Promise.all(pagesPromises).then(function (pagesText) {
                    var docType = documentName.substring(
                        documentName.indexOf("[") + 1, 
                        documentName.lastIndexOf("]")
                    );
                    
                    if(docType.toLowerCase() === "gcash"){
                        gcashParser(pagesText);
                    }else if(docType === "Maya"){

                    }
                });

            }, function (reason) {
                // PDF loading error
                alert(reason.message);
            });
        }

    </script>
</body>

</html>